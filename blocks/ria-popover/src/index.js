import { registerBlockType } from '@wordpress/blocks';
import { InspectorControls, InnerBlocks, useBlockProps, PanelColorSettings } from '@wordpress/block-editor';
import { PanelBody, SelectControl, TextControl, ToggleControl, RangeControl } from '@wordpress/components';
import { __ } from '@wordpress/i18n';
import './style.scss';
import metadata from './block.json';
import { Menu, Settings, Filter, Info } from 'lucide-react';

registerBlockType(metadata.name, {
	edit: ({ attributes, setAttributes }) => {
		const { triggerText, triggerType, triggerIcon, position, width, offset, showArrow, closeOnOutsideClick, closeOnEscape, buttonVariant, buttonSize, customBackgroundColor, customTextColor, customBorderColor, variant = 'default', customColor } = attributes;
		const blockProps = useBlockProps({ className: 'ria-popover-wrapper' });
		const TEMPLATE = [['core/heading', { level: 4, placeholder: 'Popover Title' }], ['core/paragraph', { placeholder: 'Add content...' }]];
		const ICONS = [{ label: 'Menu', value: 'menu' }, { label: 'Settings', value: 'admin-settings' }, { label: 'Filter', value: 'filter' }, { label: 'Info', value: 'info' }];
		const iconMap = { 'menu': Menu, 'admin-settings': Settings, 'filter': Filter, 'info': Info };
		const IconComponent = triggerIcon ? iconMap[triggerIcon] : Menu;
		const classes = ['ria-popover-trigger', `ria-popover-trigger--${triggerType}`, triggerType === 'button' ? `ria-popover-trigger--${buttonVariant}` : '', triggerType === 'button' ? `ria-popover-trigger--${buttonSize}` : ''].filter(Boolean).join(' ');
		const styles = {}; if (triggerType === 'button' && buttonVariant === 'custom') { if (customBackgroundColor) styles.backgroundColor = customBackgroundColor; if (customTextColor) styles.color = customTextColor; if (customBorderColor) styles.borderColor = customBorderColor; }
		return (<><InspectorControls><PanelBody title={__('Color Settings', 'riapress')} initialOpen={false}><SelectControl label={__('Color Variant', 'riapress')} value={variant} options={[{ label: 'Default', value: 'default' }, { label: 'Primary', value: 'primary' }, { label: 'Secondary', value: 'secondary' }, { label: 'Accent', value: 'accent' }, { label: 'Neutral', value: 'neutral' }, { label: 'Custom', value: 'custom' }]} onChange={(v) => setAttributes({ variant: v })} /></PanelBody>{variant === 'custom' && <PanelColorSettings title={__('Custom Colors', 'riapress')} colorSettings={[{ value: customColor, onChange: (v) => setAttributes({ customColor: v }), label: 'Text Color' }, { value: customBackgroundColor, onChange: (v) => setAttributes({ customBackgroundColor: v }), label: 'Background Color' }, { value: customBorderColor, onChange: (v) => setAttributes({ customBorderColor: v }), label: 'Border Color' }]} />}<PanelBody title={__('Trigger', 'riapress')} initialOpen={true}><SelectControl label={__('Type', 'riapress')} value={triggerType} options={[{ label: 'Button', value: 'button' }, { label: 'Link', value: 'link' }, { label: 'Icon', value: 'icon' }]} onChange={(v) => setAttributes({ triggerType: v })} />{triggerType !== 'icon' && <TextControl label={__('Text', 'riapress')} value={triggerText} onChange={(v) => setAttributes({ triggerText: v })} />}{triggerType === 'icon' && <SelectControl label={__('Icon', 'riapress')} value={triggerIcon} options={ICONS} onChange={(v) => setAttributes({ triggerIcon: v })} />}{triggerType === 'button' && <><SelectControl label={__('Variant', 'riapress')} value={buttonVariant} options={[{ label: 'Primary', value: 'primary' }, { label: 'Secondary', value: 'secondary' }, { label: 'Tertiary', value: 'tertiary' }, { label: 'Outline Primary', value: 'outline-primary' }, { label: 'Outline Secondary', value: 'outline-secondary' }, { label: 'Outline Tertiary', value: 'outline-tertiary' }, { label: 'Ghost', value: 'ghost' }, { label: 'Link', value: 'link' }, { label: 'Custom', value: 'custom' }]} onChange={(v) => setAttributes({ buttonVariant: v })} /><SelectControl label={__('Size', 'riapress')} value={buttonSize} options={[{ label: 'Small', value: 'small' }, { label: 'Medium', value: 'medium' }, { label: 'Large', value: 'large' }]} onChange={(v) => setAttributes({ buttonSize: v })} /></>}</PanelBody>{triggerType === 'button' && buttonVariant === 'custom' && <PanelColorSettings title={__('Button Custom Colors', 'riapress')} colorSettings={[{ value: customTextColor, onChange: (v) => setAttributes({ customTextColor: v }), label: 'Text' }]} />}<PanelBody title={__('Settings', 'riapress')}><SelectControl label={__('Position', 'riapress')} value={position} options={[{ label: 'Top', value: 'top' }, { label: 'Bottom', value: 'bottom' }, { label: 'Left', value: 'left' }, { label: 'Right', value: 'right' }]} onChange={(v) => setAttributes({ position: v })} /><TextControl label={__('Width', 'riapress')} value={width} onChange={(v) => setAttributes({ width: v })} /><RangeControl label={__('Offset', 'riapress')} value={offset} onChange={(v) => setAttributes({ offset: v })} min={0} max={50} /><ToggleControl label={__('Arrow', 'riapress')} checked={showArrow} onChange={(v) => setAttributes({ showArrow: v })} /></PanelBody></InspectorControls><div {...blockProps}><div className="ria-popover-editor"><div className={classes} style={Object.keys(styles).length > 0 ? styles : undefined}>{triggerType === 'icon' ? <IconComponent size={20} /> : <span>{triggerText}</span>}</div><div className={`ria-popover-content-editor${variant !== 'default' ? ` has-${variant}-variant` : ''}${variant === 'custom' ? ' has-custom-colors' : ''}`} style={{ width, ...(variant === 'custom' && customColor ? { '--custom-color': customColor } : {}), ...(variant === 'custom' && customBackgroundColor ? { '--custom-background-color': customBackgroundColor } : {}), ...(variant === 'custom' && customBorderColor ? { '--custom-border-color': customBorderColor } : {}) }}><div className="ria-popover-arrow-indicator">Popover Content</div><InnerBlocks template={TEMPLATE} /></div></div></div></>);
	},
	save: ({ attributes }) => {
		const { triggerText, triggerType, triggerIcon, position, align, width, offset, showArrow, closeOnOutsideClick, closeOnEscape, buttonVariant, buttonSize, customBackgroundColor, customTextColor, customBorderColor, variant = 'default', customColor } = attributes;
		const contentClasses = ['ria-popover-content']; if (variant !== 'default') contentClasses.push(`has-${variant}-variant`); if (variant === 'custom' && (customColor || customBackgroundColor || customBorderColor)) contentClasses.push('has-custom-colors');
		const contentStyles = {}; if (variant === 'custom') { if (customColor) contentStyles['--custom-color'] = customColor; if (customBackgroundColor) contentStyles['--custom-background-color'] = customBackgroundColor; if (customBorderColor) contentStyles['--custom-border-color'] = customBorderColor; }
		const blockProps = useBlockProps.save({ className: 'ria-popover-wrapper', 'data-position': position, 'data-align': align, 'data-width': width, 'data-offset': offset, 'data-show-arrow': showArrow, 'data-close-outside': closeOnOutsideClick, 'data-close-escape': closeOnEscape });
		const iconMap = { 'menu': Menu, 'admin-settings': Settings, 'filter': Filter, 'info': Info };
		const IconComponent = triggerIcon ? iconMap[triggerIcon] : Menu;
		const classes = ['ria-popover-trigger', `ria-popover-trigger--${triggerType}`, triggerType === 'button' ? `ria-popover-trigger--${buttonVariant}` : '', triggerType === 'button' ? `ria-popover-trigger--${buttonSize}` : ''].filter(Boolean).join(' ');
		const styles = {}; if (triggerType === 'button' && buttonVariant === 'custom') { if (customBackgroundColor) styles.backgroundColor = customBackgroundColor; if (customTextColor) styles.color = customTextColor; if (customBorderColor) styles.borderColor = customBorderColor; }
		return (<div {...blockProps}><button className={classes} style={Object.keys(styles).length > 0 ? styles : undefined} type="button" aria-haspopup="true" aria-expanded="false">{triggerType === 'icon' ? <IconComponent size={20} aria-label={triggerText} /> : <span>{triggerText}</span>}</button><div className={contentClasses.join(' ')} style={Object.keys(contentStyles).length > 0 ? contentStyles : undefined} role="dialog" aria-hidden="true">{showArrow && <div className="ria-popover-arrow"></div>}<div className="ria-popover-inner"><InnerBlocks.Content /></div></div></div>);
	}
});
